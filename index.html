<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1, maximum=1">
    <title>ARtedita 3D Viewer</title>
    <script src="encantar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-v1.6.0.min.js"></script>
    <script src="aframe-with-encantar.js"></script>

    <!-- ① CAP DPR: limita el devicePixelRatio ANTES de que A-Frame cree el renderer -->
    <script>
      (function capDPR () {
        const MAX_DPR = 1.5; // súbelo para más calidad (2.0) o bájalo para más FPS (1.0–1.25)
        const current = window.devicePixelRatio || 1;
        if (current > MAX_DPR) {
          Object.defineProperty(window, 'devicePixelRatio', { get: () => MAX_DPR });
        }
      })();
    </script>

    <style>
        /* Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%;
            overflow: hidden; background: #000;
            font-family: Arial, sans-serif;
            position: fixed; top: 0; left: 0;
        }
        @media (max-width: 768px) {
            html, body { height: 100vh; height: -webkit-fill-available; }
        }

        /* Fullscreen A-Frame/AR */
        a-scene, ar-viewport, ar-hud {
            width: 100vw !important;
            height: 100vh !important;
            height: -webkit-fill-available !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
        }
        a-scene { z-index: 1 !important; }

        /* Aim overlay (LEGO) */
        #aim-overlay {
            position: fixed !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 80vmin !important; height: auto !important;
            z-index: 1001 !important; pointer-events: none !important;
            transition: opacity .25s ease;
        }
        #aim-overlay svg {
            width: 100% !important;
            height: auto !important;
        }

        /* Custom loader spin animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #aim-overlay.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<script>
  // Hide custom loader when AR is ready and manage LEGO overlay
  document.addEventListener('DOMContentLoaded', () => {
    const scene = document.querySelector('a-scene');
    const aimOverlay = document.getElementById('aim-overlay');
    const customLoader = document.getElementById('custom-loader');
    if (!scene || !aimOverlay) return;

    // Hide loader when AR session starts
    scene.addEventListener('enter-vr', () => {
      if (customLoader) customLoader.style.display = 'none';
    });

    // Also hide loader after a delay as fallback
    setTimeout(() => {
      if (customLoader) customLoader.style.display = 'none';
    }, 3000);

    // Animaciones del overlay (para pausarlas y ahorrar GPU)
    const overlayAnims = aimOverlay.querySelectorAll('.stroke-main, .stroke-halo');
    const pauseOverlay = () => overlayAnims.forEach(n => n.style.animationPlayState = 'paused');
    const playOverlay  = () => overlayAnims.forEach(n => n.style.animationPlayState = 'running');

    scene.addEventListener('artargetfound', (ev) => {
      const ref = ev.detail && ev.detail.referenceImage;
      if (!ref || ref.name === 'my-reference-image') {
        aimOverlay.classList.add('hidden');  // usa tu CSS: opacity 0
        pauseOverlay();
      }
    });

    scene.addEventListener('artargetlost', (ev) => {
      const ref = ev.detail && ev.detail.referenceImage;
      if (!ref || ref.name === 'my-reference-image') {
        aimOverlay.classList.remove('hidden');
        playOverlay();
      }
    });
  });
</script>
<body>
    <!-- Custom Loading Screen -->
    <div id="custom-loader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle at center, #0f172a, #020617);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', sans-serif;
        color: white;
        z-index: 9999;
    ">
        <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            max-width: 300px;
            width: 90%;
            text-align: center;
        ">
            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="
                width: 100px;
                height: 100px;
                animation: spin 3s linear infinite;
                margin-bottom: 1rem;
                filter: drop-shadow(0 0 10px gold);
            ">
                <rect x="20" y="8" width="24" height="8" rx="2" fill="#FFD700" />
                <rect x="12" y="16" width="40" height="32" rx="8" fill="#FFD700" />
                <rect x="20" y="48" width="24" height="8" rx="2" fill="#FFD700" />
                <rect x="12" y="16" width="40" height="32" rx="8" stroke="#FFEA00" stroke-width="2"/>
            </svg>
            <h2 style="
                font-size: 1.5rem;
                font-weight: 600;
                letter-spacing: 0.5px;
                margin: 0;
            ">Cargando Experiencia</h2>
        </div>
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene
        encantar="stats: false; gizmos: false; powerPreference: high-performance"
        loading-screen="enabled: false"
        <!-- ② Renderer performance-first -->
        renderer="antialias: false; precision: mediump; physicallyCorrectLights: false; alpha: false; sortObjects: true; logarithmicDepthBuffer: true"
    >

        <!-- Sources -->
        <ar-sources>
            <ar-camera-source></ar-camera-source>
        </ar-sources>

        <!-- Tracker -->
        <ar-trackers>
            <ar-image-tracker>
                <ar-reference-image name="my-reference-image" src="custom-reference.png"></ar-reference-image>
            </ar-image-tracker>
        </ar-trackers>

        <!-- AR Viewport + HUD -->
        <ar-viewport>
            <ar-hud>
                <!-- LEGO head aim overlay (SUPER LIGHT ++ más notorio) -->
                <div id="aim-overlay">
                  <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Blur ligero del halo -->
                    <defs>
                      <filter id="haloLite" x="-30%" y="-30%" width="160%" height="160%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="5" />
                      </filter>
                    </defs>

                    <style>
                      /* Contorno principal (sin filtros pesados) */
                      .stroke-main {
                        fill: none;
                        stroke: #fff38a;           /* amarillo suave */
                        stroke-width: 4.5;
                        vector-effect: non-scaling-stroke;
                        stroke-linejoin: round;
                        stroke-linecap: round;
                        animation: mainPulse 2.2s ease-in-out infinite;
                      }

                      /* HALO: más ancho, más opaco, sin animar grosor */
                      .stroke-halo {
                        fill: none;
                        stroke: #fff955;           /* tono vivo base */
                        stroke-width: 11;          /* antes 9 */
                        opacity: .5;               /* antes .35 */
                        vector-effect: non-scaling-stroke;
                        stroke-linejoin: round;
                        stroke-linecap: round;
                        animation: haloPulse 2.2s ease-in-out infinite;
                      }

                      /* Relleno dorado translúcido de la figura */
                      .fill-base { fill: rgba(255, 215, 0, 0.22); }

                      /* Animaciones baratas (color/opacidad) */
                      @keyframes mainPulse {
                        0%   { stroke: #fff38a; }
                        50%  { stroke: #ffff3d; }  /* pico */
                        100% { stroke: #fff38a; }
                      }
                      @keyframes haloPulse {
                        0%   { opacity: .4; stroke: #fff266; }
                        50%  { opacity: .75; stroke: #ffff33; } /* pico más neón */
                        100% { opacity: .4; stroke: #fff266; }
                      }

                      @media (prefers-reduced-motion: reduce) {
                        .stroke-main, .stroke-halo { animation: none; }
                      }
                    </style>

                    <!-- BASE (relleno) -->
                    <g class="fill-base">
                      <rect x="15" y="20" width="70" height="60" rx="18" ry="18"/>
                      <rect x="38" y="10" width="24" height="12" rx="3" ry="3"/>
                      <rect x="33" y="80" width="34" height="10" rx="3" ry="3"/>
                    </g>

                    <!-- HALO con blur ligero y animación de opacidad -->
                    <g style="filter:url(#haloLite);">
                      <rect class="stroke-halo" x="15" y="20" width="70" height="60" rx="18" ry="18"/>
                      <rect class="stroke-halo" x="38" y="10" width="24" height="12" rx="3" ry="3"/>
                      <rect class="stroke-halo" x="33" y="80" width="34" height="10" rx="3" ry="3"/>
                    </g>

                    <!-- CONTORNO PRINCIPAL -->
                    <g>
                      <rect class="stroke-main" x="15" y="20" width="70" height="60" rx="18" ry="18"/>
                      <rect class="stroke-main" x="38" y="10" width="24" height="12" rx="3" ry="3"/>
                      <rect class="stroke-main" x="33" y="80" width="34" height="10" rx="3" ry="3"/>
                    </g>
                  </svg>
                </div>
            </ar-hud>
        </ar-viewport>

        <!-- AR Camera -->
        <ar-camera></ar-camera>

        <!-- MAIN AR SCENE -->
        <ar-root id="main-scene" reference-image="my-reference-image" visible="true">
            <a-gltf-model id="face-model"
                          src="base_basic_shaded.glb"
                          position="0 -1 0"
                          scale="1 1 1"
                          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
                          shadow="cast: true; receive: true">
            </a-gltf-model>

            <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
            <a-light type="directional" position="2 4 2" color="#ffffff" intensity="1.0" shadow="cast: true"></a-light>
            <a-light type="point" position="-1 2 1" color="#4CAF50" intensity="0.3"></a-light>
            <a-light type="point" position="1 2 1" color="#2196F3" intensity="0.3"></a-light>
        </ar-root>

    </a-scene>
</body>
</html>


