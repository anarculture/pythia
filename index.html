<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1">
    <title>ARtedita 3D Viewer</title>
    <!-- Local, version-pinned builds recommended for production -->
    <script src="encantar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-v1.6.0.min.js"></script>
    <script src="aframe-with-encantar.js"></script>

    <!-- ① CAP DPR: limita el devicePixelRatio ANTES de que A-Frame cree el renderer -->
    <script>
      (function capDPR () {
        const MAX_DPR = 1.5; // súbelo para más calidad (2.0) o bájalo para más FPS (1.0–1.25)
        const current = window.devicePixelRatio || 1;
        if (current > MAX_DPR) {
          Object.defineProperty(window, 'devicePixelRatio', { get: () => MAX_DPR });
        }
      })();
    </script>

    <style>
        /* Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%;
            overflow: hidden; background: transparent;
            font-family: Arial, sans-serif;
            position: fixed; top: 0; left: 0;
        }
        @media (max-width: 768px) {
            html, body { height: 100vh; height: -webkit-fill-available; }
        }

        /* Fullscreen A-Frame/AR */
        a-scene, ar-viewport, ar-hud {
            width: 100vw !important;
            height: 100vh !important;
            height: -webkit-fill-available !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
        }
        a-scene { z-index: 1 !important; }
        ar-hud { z-index: 1000 !important; }
        
        /* Ensure AR viewport is visible */
        ar-viewport {
            background: transparent !important;
            z-index: 2 !important;
        }

        /* Aim overlay glow effect */
        #aim-overlay.glow-exit {
            animation: glowAndFade 1.5s ease-out forwards;
        }
        
        @keyframes glowAndFade {
            0% {
                opacity: 1;
                filter: drop-shadow(0 0 0px #FFD700);
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.8;
                filter: drop-shadow(0 0 30px #FFD700) drop-shadow(0 0 60px #FFD700);
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                opacity: 0;
                filter: drop-shadow(0 0 50px #FFD700) drop-shadow(0 0 100px #FFD700);
                transform: translate(-50%, -50%) scale(1.3);
            }
        }

        /* Aim overlay (LEGO) */
        #aim-overlay {
            position: fixed !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 80vmin !important; height: auto !important;
            z-index: 1001 !important; pointer-events: none !important;
            transition: opacity .25s ease;
        }
        #aim-overlay svg {
            width: 100% !important;
            height: auto !important;
        }

        /* Enhanced animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }
        
        @keyframes progressPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes scanPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeInScale {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        #aim-overlay.hidden { opacity: 0; pointer-events: none; }
        
        /* Enhanced aim overlay with better visibility */
        #aim-overlay {
            animation: fadeInScale 0.5s ease-out;
        }
        
        /* Improved mobile touch targets */
        @media (max-width: 768px) {
            button, .touch-target {
                min-height: 48px;
                min-width: 48px;
                padding: 12px 24px;
            }
        }
        
        /* Status indicator styles */
        .status-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            animation: slideInUp 0.5s ease-out;
        }
        
        /* Particle burst animation for model unlock */
        .particle-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            pointer-events: none;
            z-index: 1500;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0;
        }
        
        @keyframes sparkBurst {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
                filter: brightness(2);
            }
            50% {
                opacity: 1;
                filter: brightness(1.5);
            }
            100% {
                opacity: 0;
                transform: scale(1) rotate(360deg);
                filter: brightness(0.5);
            }
        }
        
        @keyframes centerFlash {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
                background: radial-gradient(circle, #FFD700 0%, transparent 70%);
            }
            30% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.5);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(3);
            }
        }
        
        .center-flash {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1400;
            animation: centerFlash 1s ease-out;
        }
        
        .status-indicator.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .status-indicator.warning {
            background: rgba(255, 152, 0, 0.9);
        }
        
        .status-indicator.error {
            background: rgba(244, 67, 54, 0.9);
        }
    </style>
</head>

<script>
  // Enhanced UX management with loading, onboarding, and status feedback
  document.addEventListener('DOMContentLoaded', () => {
    const scene = document.querySelector('a-scene');
    const aimOverlay = document.getElementById('aim-overlay');
    const customLoader = document.getElementById('custom-loader');
    const onboardingOverlay = document.getElementById('onboarding-overlay');
    const startArBtn = document.getElementById('start-ar-btn');
    const progressBar = document.getElementById('progress-bar');
    
    let loadingProgress = 0;
    let isFirstTime = !localStorage.getItem('artedita-visited');
    
    // Enhanced loading sequence with progress
    const updateProgress = (progress) => {
      loadingProgress = Math.min(progress, 100);
      if (progressBar) {
        progressBar.style.width = loadingProgress + '%';
      }
    };
    
    // Simulate loading progress
    const loadingSteps = [
      { progress: 20, delay: 300, text: 'Cargando AR...' },
      { progress: 50, delay: 600, text: 'Iniciando cámara...' },
      { progress: 80, delay: 900, text: 'Preparando experiencia...' },
      { progress: 100, delay: 1200, text: 'Listo!' }
    ];
    
    let stepIndex = 0;
    const processLoadingStep = () => {
      if (stepIndex < loadingSteps.length) {
        const step = loadingSteps[stepIndex];
        updateProgress(step.progress);
        
        // Update loading text
        const loadingText = customLoader?.querySelector('p');
        if (loadingText) loadingText.textContent = step.text;
        
        stepIndex++;
        setTimeout(processLoadingStep, step.delay);
      }
    }
    
    // Track AR system readiness
    let arSystemReady = false;
    let cameraReady = false;
    
    // Much simpler: Just use a timer after loading steps complete
    console.log('Starting AR initialization timer...');
    setTimeout(() => {
      console.log('Timer complete - hiding loader');
      if (customLoader && customLoader.style.display !== 'none') {
        customLoader.classList.add('fade-out');
        setTimeout(() => {
          customLoader.style.display = 'none';
          // Show scanning instructions after loader hides
          showScanningInstructions();
        }, 500);
      }
    }, 4000); // 4 seconds total (2 for steps + 2 for AR)
    
    // Scanning state management
    function showScanningInstructions() {
      console.log('Showing scanning instructions');
      const scanningOverlay = document.getElementById('scanning-overlay');
      if (scanningOverlay) {
        scanningOverlay.style.display = 'flex';
        scanningOverlay.style.animation = 'fadeIn 0.5s ease-out';
        // Setup button listener after overlay is shown
        setTimeout(setupContinueButton, 100);
      }
    }
    
    function hideScanningInstructions() {
      console.log('Hiding scanning instructions');
      const scanningOverlay = document.getElementById('scanning-overlay');
      if (scanningOverlay) {
        scanningOverlay.classList.add('fade-out');
        setTimeout(() => scanningOverlay.style.display = 'none', 500);
      }
    }
    
    // Continue button event listener - moved to main DOMContentLoaded
    const setupContinueButton = () => {
      const continueBtn = document.getElementById('continue-scanning-btn');
      if (continueBtn) {
        console.log('Setting up continue button listener');
        continueBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Continue button clicked - hiding scanning overlay');
          hideScanningInstructions();
          // Show scanning indicator after overlay is hidden
          setTimeout(() => {
            const scanningIndicator = document.getElementById('scanning-indicator');
            if (scanningIndicator) {
              scanningIndicator.style.display = 'flex';
            }
          }, 600);
        });
        
        // Also add touch event for mobile
        continueBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          console.log('Continue button touched - hiding scanning overlay');
          hideScanningInstructions();
          // Show scanning indicator after overlay is hidden
          setTimeout(() => {
            const scanningIndicator = document.getElementById('scanning-indicator');
            if (scanningIndicator) {
              scanningIndicator.style.display = 'flex';
            }
          }, 600);
        });
      } else {
        console.log('Continue button not found');
      }
    };
    
    
    // Onboarding management
    const showOnboarding = () => {
      if (onboardingOverlay) {
        onboardingOverlay.style.display = 'flex';
        onboardingOverlay.style.animation = 'fadeInScale 0.5s ease-out';
      }
    };
    
    const hideOnboarding = () => {
      if (onboardingOverlay) {
        onboardingOverlay.style.opacity = '0';
        setTimeout(() => {
          onboardingOverlay.style.display = 'none';
          localStorage.setItem('artedita-visited', 'true');
        }, 300);
      }
    };
    
    // Start AR button handler
    if (startArBtn) {
      startArBtn.addEventListener('click', hideOnboarding);
      startArBtn.addEventListener('touchend', hideOnboarding);
    }
    
    // Status indicator system
    const showStatus = (message, type = 'info', duration = 3000) => {
      // Remove existing status indicators
      document.querySelectorAll('.status-indicator').forEach(el => el.remove());
      
      const indicator = document.createElement('div');
      indicator.className = `status-indicator ${type}`;
      indicator.textContent = message;
      document.body.appendChild(indicator);
      
      setTimeout(() => {
        indicator.style.opacity = '0';
        indicator.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => indicator.remove(), 300);
      }, duration);
    };
    
    // Enhanced AR event handling
    if (scene && aimOverlay) {
      // Overlay animations management
      const overlayAnims = aimOverlay.querySelectorAll('.stroke-main, .stroke-halo');
      const pauseOverlay = () => overlayAnims.forEach(n => n.style.animationPlayState = 'paused');
      const playOverlay = () => overlayAnims.forEach(n => n.style.animationPlayState = 'running');
      
      // AR session events
      scene.addEventListener('enter-vr', () => {
        showStatus('Sesión AR iniciada', 'success');
      });
      
      // AR ready event - don't show scanning indicator yet
      scene.addEventListener('arready', () => {
        console.log('AR Ready - waiting for instruction overlay to be dismissed');
      });
      
      // Persistent model tracking - anchor after first detection
      let modelAnchored = false;
      
      scene.addEventListener('artargetfound', (ev) => {
        console.log('AR Target Found Event:', ev);
        const ref = ev.detail && ev.detail.referenceImage;
        console.log('Reference image:', ref);
        if (!ref || ref.name === 'my-reference-image') {
          pauseOverlay();
          showStatus('¡Objetivo detectado!', 'success');
          
          // Hide scanning indicator
          const scanningIndicator = document.getElementById('scanning-indicator');
          if (scanningIndicator) {
            scanningIndicator.style.display = 'none';
          }
          
          // Make aim overlay glow and fade out, then hide completely
          aimOverlay.classList.add('glow-exit');
          setTimeout(() => {
            aimOverlay.style.display = 'none';
            aimOverlay.classList.remove('glow-exit');
          }, 1500); // Match animation duration
          
          // Show centered model immediately after first detection
          if (!modelAnchored) {
            // Hide AR-tracked model immediately
            const arRoot = document.getElementById('main-scene');
            if (arRoot) {
              arRoot.setAttribute('visible', 'false');
            }
            
            // Show centered model instantly with particle burst
            showCenteredModel();
            triggerParticleBurst();
            modelAnchored = true;
            showStatus('¡Modelo desbloqueado!', 'success', 4000);
          }
        }
      });
      
      // Show centered model function
      const showCenteredModel = () => {
        console.log('Showing centered model...');
        const arRoot = document.getElementById('main-scene');
        const camera = document.querySelector('ar-camera');
        
        if (!arRoot || !camera) {
          console.error('Could not find AR elements');
          return;
        }
        
        // Create centered container directly in scene
        const centeredContainer = document.createElement('a-entity');
        centeredContainer.id = 'centered-model';
        
        // Position model centered in camera view (5 units back)
        centeredContainer.setAttribute('position', '0 0 -5');
        centeredContainer.setAttribute('scale', '1 1 1');
        
        // Create the model element
        const centeredModel = document.createElement('a-gltf-model');
        centeredModel.id = 'centered-face-model';
        centeredModel.setAttribute('src', 'base_basic_shaded.glb');
        centeredModel.setAttribute('position', '0 -1 0');
        centeredModel.setAttribute('scale', '1 1 1');
        centeredModel.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000');
        centeredModel.setAttribute('shadow', 'cast: true; receive: true');
        
        // Create lights
        const ambientLight = document.createElement('a-light');
        ambientLight.setAttribute('type', 'ambient');
        ambientLight.setAttribute('color', '#ffffff');
        ambientLight.setAttribute('intensity', '2.51');
        
        const directionalLight = document.createElement('a-light');
        directionalLight.setAttribute('type', 'directional');
        directionalLight.setAttribute('position', '2 4 2');
        directionalLight.setAttribute('color', '#ffffff');
        directionalLight.setAttribute('intensity', '3.14');
        directionalLight.setAttribute('shadow', 'cast: true');
        
        const pointLight1 = document.createElement('a-light');
        pointLight1.setAttribute('type', 'point');
        pointLight1.setAttribute('position', '-1 2 1');
        pointLight1.setAttribute('color', '#4CAF50');
        pointLight1.setAttribute('intensity', '30');
        pointLight1.setAttribute('decay', '2');
        
        const pointLight2 = document.createElement('a-light');
        pointLight2.setAttribute('type', 'point');
        pointLight2.setAttribute('position', '1 2 1');
        pointLight2.setAttribute('color', '#2196F3');
        pointLight2.setAttribute('intensity', '30');
        pointLight2.setAttribute('decay', '2');
        
        // Add elements to container
        centeredContainer.appendChild(centeredModel);
        centeredContainer.appendChild(ambientLight);
        centeredContainer.appendChild(directionalLight);
        centeredContainer.appendChild(pointLight1);
        centeredContainer.appendChild(pointLight2);
        
        // Add to main scene
        scene.appendChild(centeredContainer);
        
        // Hide original AR-tracked model
        arRoot.setAttribute('visible', 'false');
        
        console.log('Model centered at position: 0 0 -5');
      };
      
      // Particle burst effect for model unlock
      const triggerParticleBurst = () => {
        console.log('Triggering particle burst effect...');
        
        // Create center flash
        const centerFlash = document.createElement('div');
        centerFlash.className = 'center-flash';
        document.body.appendChild(centerFlash);
        
        // Create particle burst container
        const burstContainer = document.createElement('div');
        burstContainer.className = 'particle-burst';
        document.body.appendChild(burstContainer);
        
        // Generate particles in a burst pattern
        const particleCount = 20;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          
          // Random position around center
          const angle = (i / particleCount) * 360 + Math.random() * 30;
          const distance = 50 + Math.random() * 100;
          const x = Math.cos(angle * Math.PI / 180) * distance;
          const y = Math.sin(angle * Math.PI / 180) * distance;
          
          particle.style.left = `calc(50% + ${x}px)`;
          particle.style.top = `calc(50% + ${y}px)`;
          
          // Random animation delay and duration
          const delay = Math.random() * 0.3;
          const duration = 0.8 + Math.random() * 0.4;
          
          particle.style.animation = `sparkBurst ${duration}s ease-out ${delay}s forwards`;
          
          // Random colors (gold variations)
          const colors = ['#FFD700', '#FFA500', '#FF8C00', '#FFE55C', '#FFFF00'];
          particle.style.background = colors[Math.floor(Math.random() * colors.length)];
          
          burstContainer.appendChild(particle);
        }
        
        // Clean up after animation
        setTimeout(() => {
          centerFlash.remove();
          burstContainer.remove();
        }, 2000);
      };
      
      
      
      // Error handling
      scene.addEventListener('ar-error', (ev) => {
        showStatus('Error AR: ' + (ev.detail?.message || 'Error desconocido'), 'error', 5000);
      });
      
      // Camera permission handling
      navigator.mediaDevices?.getUserMedia({ video: true })
        .then(() => {
          showStatus('Cámara lista', 'success', 2000);
        })
        .catch(() => {
          showStatus('Permiso de cámara requerido', 'error', 5000);
        });
    }
    
    // Performance monitoring
    let frameCount = 0;
    let lastTime = performance.now();
    
    const monitorPerformance = () => {
      frameCount++;
      const currentTime = performance.now();
      
      if (currentTime - lastTime >= 5000) { // Check every 5 seconds
        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
        
        if (fps < 20) {
          showStatus('Rendimiento bajo detectado', 'warning', 3000);
        }
        
        frameCount = 0;
        lastTime = currentTime;
      }
      
      requestAnimationFrame(monitorPerformance);
    };
    
    // Start performance monitoring
    requestAnimationFrame(monitorPerformance);
  });
</script>

<body>
    <!-- Enhanced Loading Screen -->
    <div id="custom-loader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: white;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
    ">
        <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        ">
            <!-- Modern AR Icon -->
            <div style="
                width: 120px;
                height: 120px;
                margin-bottom: 2rem;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <svg viewBox="0 0 100 100" style="
                    width: 100%;
                    height: 100%;
                    animation: pulse 2s ease-in-out infinite;
                ">
                    <defs>
                        <linearGradient id="arGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- AR Cube -->
                    <rect x="25" y="25" width="50" height="50" rx="8" fill="url(#arGradient)" opacity="0.8"/>
                    <rect x="25" y="25" width="50" height="50" rx="8" fill="none" stroke="#fff" stroke-width="2"/>
                    <!-- AR Points -->
                    <circle cx="15" cy="15" r="3" fill="#fff" opacity="0.9"/>
                    <circle cx="85" cy="15" r="3" fill="#fff" opacity="0.9"/>
                    <circle cx="15" cy="85" r="3" fill="#fff" opacity="0.9"/>
                    <circle cx="85" cy="85" r="3" fill="#fff" opacity="0.9"/>
                    <!-- Connecting lines -->
                    <line x1="18" y1="15" x2="25" y2="25" stroke="#fff" stroke-width="1" opacity="0.6"/>
                    <line x1="82" y1="15" x2="75" y2="25" stroke="#fff" stroke-width="1" opacity="0.6"/>
                    <line x1="18" y1="85" x2="25" y2="75" stroke="#fff" stroke-width="1" opacity="0.6"/>
                    <line x1="82" y1="85" x2="75" y2="75" stroke="#fff" stroke-width="1" opacity="0.6"/>
                </svg>
            </div>
            
            <h2 style="
                font-size: 1.8rem;
                font-weight: 700;
                letter-spacing: 0.5px;
                margin: 0 0 0.5rem 0;
                background: linear-gradient(45deg, #FFD700, #FFA500);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            ">ARtedita</h2>
            
            <p style="
                font-size: 1rem;
                opacity: 0.9;
                margin: 0 0 1.5rem 0;
                font-weight: 300;
            ">Iniciando experiencia AR...</p>
            
            <!-- Progress Bar -->
            <div style="
                width: 100%;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                overflow: hidden;
            ">
                <div id="progress-bar" style="
                    width: 0%;
                    height: 100%;
                    background: linear-gradient(90deg, #FFD700, #FFA500);
                    border-radius: 2px;
                    transition: width 0.3s ease;
                    animation: progressPulse 1.5s ease-in-out infinite;
                "></div>
            </div>
        </div>
    </div>

    <!-- Scanning Instructions Overlay -->
    <div id="scanning-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: white;
        z-index: 9999;
    ">
        <div style="
            text-align: center;
            max-width: 350px;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        ">
            <!-- Scanning Animation -->
            <div style="
                width: 100px;
                height: 100px;
                margin: 0 auto 2rem auto;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <svg viewBox="0 0 100 100" style="
                    width: 100%;
                    height: 100%;
                    animation: scanPulse 2s ease-in-out infinite;
                ">
                    <!-- Scanning Frame -->
                    <rect x="20" y="20" width="60" height="60" rx="8" 
                          fill="none" stroke="#FFD700" stroke-width="3" 
                          stroke-dasharray="10,5" opacity="0.8">
                        <animateTransform attributeName="transform" 
                                        type="rotate" 
                                        values="0 50 50;360 50 50" 
                                        dur="3s" 
                                        repeatCount="indefinite"/>
                    </rect>
                    <!-- Center Target -->
                    <circle cx="50" cy="50" r="8" fill="#FFD700" opacity="0.6"/>
                    <!-- Corner Markers -->
                    <path d="M15,15 L25,15 L25,25" stroke="#fff" stroke-width="2" fill="none"/>
                    <path d="M85,15 L75,15 L75,25" stroke="#fff" stroke-width="2" fill="none"/>
                    <path d="M15,85 L25,85 L25,75" stroke="#fff" stroke-width="2" fill="none"/>
                    <path d="M85,85 L75,85 L75,75" stroke="#fff" stroke-width="2" fill="none"/>
                </svg>
            </div>
            
            <h2 style="
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0 0 1rem 0;
                color: #FFD700;
            ">Busca la imagen de referencia</h2>
            
            <p style="
                font-size: 1rem;
                opacity: 0.9;
                margin: 0 0 1.5rem 0;
                line-height: 1.4;
            ">Apunta tu cámara hacia la imagen de referencia para activar la experiencia AR</p>
            
            <button id="continue-scanning-btn" style="
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: #000;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 1rem;
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            " onmouseover="this.style.transform='scale(1.05)'" 
               onmouseout="this.style.transform='scale(1)'"
               ontouchstart="this.style.transform='scale(1.05)'" 
               ontouchend="this.style.transform='scale(1)'">
                Continuar
            </button>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: white;
        z-index: 8888;
        padding: 2rem;
    ">
        <div style="
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        ">
            <div style="
                width: 80px;
                height: 80px;
                margin: 0 auto 1.5rem;
                background: linear-gradient(45deg, #FFD700, #FFA500);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h3 style="
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0 0 1rem 0;
            ">¡Bienvenido a ARtedita!</h3>
            <p style="
                font-size: 1rem;
                line-height: 1.5;
                margin: 0 0 2rem 0;
                opacity: 0.9;
            ">Apunta tu cámara hacia la imagen de referencia para ver el modelo 3D en realidad aumentada.</p>
            <button id="start-ar-btn" style="
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: #000;
                border: none;
                padding: 1rem 2rem;
                border-radius: 50px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
                min-width: 160px;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 215, 0, 0.3)'"
               ontouchstart="this.style.transform='translateY(-2px)'"
               ontouchend="this.style.transform='translateY(0)'">
                Comenzar
            </button>
        </div>
    </div>



    <!-- Scanning Indicator -->
    <div id="scanning-indicator" style="
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        display: none;
        align-items: center;
        gap: 8px;
    ">
        <div style="
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        "></div>
        Buscando objetivo...
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene encantar="stats: false; gizmos: false" device-orientation-permission-ui="enabled: false">

        <!-- Sources of data -->
        <ar-sources>
            <ar-camera-source resolution="lg" facing-mode="environment"></ar-camera-source>
        </ar-sources>

        <!-- Trackers -->
        <ar-trackers>
            <ar-image-tracker>
                <ar-reference-image name="my-reference-image" src="reference.png"></ar-reference-image>
            </ar-image-tracker>
        </ar-trackers>

        <!-- AR Viewport -->
        <ar-viewport>
            <ar-hud>
                <!-- LEGO head aim overlay -->
                <div id="aim-overlay">
  <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="background:none">
    <defs>
      <filter id="haloLite" x="-30%" y="-30%" width="160%" height="160%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="5" />
      </filter>
    </defs>

    <style>
      .stroke-main {
        /* animation + styling still via CSS */
        stroke: #fff38a;
        stroke-width: 4.5;
        vector-effect: non-scaling-stroke;
        stroke-linejoin: round;
        stroke-linecap: round;
        animation: mainPulse 2.2s ease-in-out infinite;
      }
      .stroke-halo {
        stroke: #fff955;
        stroke-width: 11;
        opacity: .5;
        vector-effect: non-scaling-stroke;
        stroke-linejoin: round;
        stroke-linecap: round;
        animation: haloPulse 2.2s ease-in-out infinite;
      }
      @keyframes mainPulse {
        0% { stroke: #fff38a; }
        50% { stroke: #ffff3d; }
        100% { stroke: #fff38a; }
      }
      @keyframes haloPulse {
        0% { opacity: .4; stroke: #fff266; }
        50% { opacity: .75; stroke: #ffff33; }
        100% { opacity: .4; stroke: #fff266; }
      }
      @media (prefers-reduced-motion: reduce) {
        .stroke-main, .stroke-halo { animation: none; }
      }
    </style>

    <!-- BASE (use explicit fill + opacity so it never turns black) -->
    <g fill="#FFD700" fill-opacity="0.22">
      <rect x="15" y="20" width="70" height="60" rx="18" ry="18"/>
      <rect x="38" y="10" width="24" height="12" rx="3" ry="3"/>
      <rect x="33" y="80" width="34" height="10" rx="3" ry="3"/>
    </g>

    <!-- HALO: force no fill via attribute -->
    <g style="filter:url(#haloLite);">
      <rect class="stroke-halo" x="15" y="20" width="70" height="60" rx="18" ry="18" fill="none"/>
      <rect class="stroke-halo" x="38" y="10" width="24" height="12" rx="3" ry="3" fill="none"/>
      <rect class="stroke-halo" x="33" y="80" width="34" height="10" rx="3" ry="3" fill="none"/>
    </g>

    <!-- OUTLINE: force no fill via attribute -->
    <g>
      <rect class="stroke-main" x="15" y="20" width="70" height="60" rx="18" ry="18" fill="none"/>
      <rect class="stroke-main" x="38" y="10" width="24" height="12" rx="3" ry="3" fill="none"/>
      <rect class="stroke-main" x="33" y="80" width="34" height="10" rx="3" ry="3" fill="none"/>
    </g>
  </svg>
            </div>
        </ar-hud>
    </ar-viewport>

    <!-- AR Camera -->
    <ar-camera></ar-camera>

        <!-- MAIN AR SCENE (wrapped in smoothing container) -->
        <ar-root id="main-scene" reference-image="my-reference-image" visible="true">
            <!-- Smoothed container for stability -->
            <a-entity id="smoothed" smooth-pose="pos:0.18; rot:0.18; scale:0.22">
              <a-gltf-model id="face-model"
                            src="base_basic_shaded.glb"
                            position="0 -1 0"
                            scale="1 1 1"
                            animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
                            shadow="cast: true; receive: true">
              </a-gltf-model>

              <a-light type="ambient" color="#ffffff" intensity="2.51"></a-light>
              <a-light type="directional" position="2 4 2" color="#ffffff" intensity="3.14" shadow="cast: true"></a-light>
              <a-light type="point" position="-1 2 1" color="#4CAF50" intensity="30" decay="2"></a-light>
              <a-light type="point" position="1 2 1" color="#2196F3" intensity="30" decay="2"></a-light>
            </a-entity>
        </ar-root>

    </a-scene>

<!-- Pose smoothing component -->
<script>
AFRAME.registerComponent('smooth-pose', {
  schema: { pos:{default:0.18}, rot:{default:0.18}, scale:{default:0.22} },
  init(){ this.p=new THREE.Vector3(); this.q=new THREE.Quaternion(); this.s=new THREE.Vector3(); },
  tick(){
    const child = this.el.object3D;
    const parent = this.el.parentEl && this.el.parentEl.object3D;
    if (!parent) return;

    parent.getWorldPosition(this.p);
    parent.getWorldQuaternion(this.q);
    parent.getWorldScale(this.s);

    child.position.lerp(this.p, this.data.pos);
    child.quaternion.slerp(this.q, this.data.rot);
    child.scale.lerp(this.s, this.data.scale);
    child.updateMatrixWorld();
  }
});
</script>

<!-- Adaptive tracker: optimized for one-time detection -->
<script>
(function adaptiveTrackerRes(){
  const tracker = document.querySelector('ar-image-tracker');
  const cam = document.querySelector('ar-camera-source');
  if (!tracker || !cam) return;

  // Ensure camera is high; start tracker easier to acquire
  cam.setAttribute('resolution', 'lg');
  tracker.setAttribute('resolution', 'md');

  let trackerDisabled = false;
  let timer = 0;
  
  document.addEventListener('artargetfound', (ev)=>{
    const ref = ev.detail && ev.detail.referenceImage;
    if (ref && ref.name !== 'my-reference-image') return;
    
    if (!trackerDisabled) {
      clearTimeout(timer);
      timer = setTimeout(()=> {
        tracker.setAttribute('resolution','lg');
        // Disable tracker after model is anchored (3 seconds total)
        setTimeout(() => {
          console.log('Disabling tracker - model is now persistent');
          tracker.setAttribute('enabled', 'false');
          trackerDisabled = true;
        }, 2000);
      }, 1000);
    }
  });
})();
</script>

<!-- Camera focus/zoom for small marker recognition -->
<script>
(function tuneCamera() {
  // Reintenta hasta que el <video> tenga el stream
  let tries = 0;
  const tick = async () => {
    tries++;
    // Encantar usa internamente un <video>; buscamos uno visible
    const vid = document.querySelector('ar-viewport video, video');
    const track = vid && vid.srcObject && vid.srcObject.getVideoTracks && vid.srcObject.getVideoTracks()[0];
    if (!track) { if (tries < 30) setTimeout(tick, 300); return; }

    const caps = (track.getCapabilities && track.getCapabilities()) || {};
    const adv = [];

    // foco continuo / exposición / balance blancos (si el device lo soporta)
    if (caps.focusMode && caps.focusMode.includes('continuous')) adv.push({ focusMode: 'continuous' });
    if (caps.exposureMode && caps.exposureMode.includes('continuous')) adv.push({ exposureMode: 'continuous' });
    if (caps.whiteBalanceMode && caps.whiteBalanceMode.includes('continuous')) adv.push({ whiteBalanceMode: 'continuous' });

    // zoom suave inicial (hasta 2.5x si se permite)
    if (caps.zoom) {
      const z = Math.min(caps.zoom.max || 2.5, 2.5);
      adv.push({ zoom: z });
    }

    try { await track.applyConstraints({ advanced: adv }); }
    catch(e) { /* silencioso: algunos navegadores ignoran campos no soportados */ }
  };
  tick();
})();
</script>
</body>
</html>
